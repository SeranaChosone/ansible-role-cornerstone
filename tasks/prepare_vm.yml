---
# tasks file for cornerstone:prepare_vm.yml

#
# -----------------------------------------------------------------------------
# Prepare Virtual Machine Tasks
# -----------------------------------------------------------------------------
#

- name: "[Cornerstone - VM] Add VM as Ansible Host"
  add_host:
    hostname: "{{ cornerstone_vm_ipaddress }}"
    groupname: "{{ cornerstone_prefix }}"

- name: "[Cornerstone - VM] Ping VM"
  ping:



# Remove RHUI
- name: "[Cornerstone - VM] Remove RHUI"
  file:
    path: /etc/yum.repos.d/rh-cloud.repo
    state: absent
  tags: prepare

# Register with RHSM
- name: "[Cornerstone - VM] Register with Red Hat"
  redhat_subscription:
    state: present
    username: "{{ rhsm_username_org }}"
    password: "{{ rhsm_password_key }}"
    pool_ids: "{{ rhsm_pool }}"
    auto_attach: no

- name: "[Cornerstone - VM] Disable all RHSM repositories"
  rhsm_repository:
    name: '*'
    state: disabled

- name: "[Cornerstone - VM] Enable Base RHEL Server Repos"
  rhsm_repository:
    name:
      - rhel-7-server-rpms
      - rhel-7-server-extras-rpms
    state: enabled

- name: "[Cornerstone - VM] Update Packages"
  yum:
    name: '*'
    state: latest
    exclude: WALinuxAgent

- name: "[Cornerstone - Azure] Import Microsoft RPM Key"
  rpm_key:
    state: present
    key: https://packages.microsoft.com/keys/microsoft.asc

- name: "[Cornerstone - Azure] Add Azure CLI Repository"
  yum_repository:
    name: azure-cli
    description: Azure CLI
    baseurl: https://packages.microsoft.com/yumrepos/azure-cli
    gpgcheck: yes
    gpgkey: https://packages.microsoft.com/keys/microsoft.asc
